# Google OAuth Login Loop - Fixed ✅

**Date:** 2026-02-19
**Issue:** Users redirected back to login modal after selecting Google account
**Status:** FIXED

## Root Cause

Database schema mismatch causing OAuth callback to fail silently.

### The Problem
1. User clicks "Continuar con Google"
2. Redirects to Google OAuth consent screen
3. User selects account
4. Google redirects back to `/auth/google?code=...`
5. **OAuth handler queries users table for `avatar` column** ❌
6. **Column doesn't exist → PostgreSQL error** ❌
7. Error handler redirects to `/ingresar?error=oauth_error`
8. LoginModal doesn't read `?error=` param → user sees no error message
9. Loop continues...

### Error from Railway logs:
```
PostgresError: column "avatar" does not exist
  at ErrorResponse (file:///app/.output/server/node_modules/postgres/src/connection.js:815:30)
  
Failed query: select "id", "email", "name", "avatar", "provider", "provider_id", ...
```

## The Fix

### 1. Database Migration
**File:** `server/database/migrations/0001_fuzzy_domino.sql`

Added missing columns to `users` table:
```sql
ALTER TABLE "users" ADD COLUMN "avatar" text;
ALTER TABLE "users" ADD COLUMN "provider" text DEFAULT 'magic-link' NOT NULL;
ALTER TABLE "users" ADD COLUMN "provider_id" text;
```

**Applied via:**
```bash
cat server/database/migrations/0001_fuzzy_domino.sql | railway connect postgres
```

**Verified:**
```bash
echo "\\d users" | railway connect postgres
# ✅ Shows avatar, provider, provider_id columns
```

### 2. Error Display in LoginModal
**File:** `app/components/LoginModal.vue`

**Before:** Errors from `?error=` query param were ignored

**After:** 
- Reads `route.query.error`
- Maps error codes to user-friendly messages:
  - `oauth_error` → "Error al iniciar sesión con Google. Intentá de nuevo."
  - `oauth_failed` → "No se pudo completar el inicio de sesión."
  - `db_unavailable` → "Base de datos no disponible. Intentá más tarde."
  - `user_creation_failed` → "No se pudo crear tu cuenta. Contactá a soporte."
- Displays error in a `UAlert` component

### 3. Migration Runner Script
**File:** `server/database/migrate.ts`

Created reusable migration runner for future schema changes:
```bash
bun run db:migrate  # Applies pending migrations
```

**Added to package.json:**
```json
{
  "scripts": {
    "db:migrate": "bun run server/database/migrate.ts",
    "db:generate": "drizzle-kit generate"
  }
}
```

## Testing Checklist

- [ ] Visit https://juridica.ar/ingresar
- [ ] Click "Continuar con Google"
- [ ] Select Google account (use: canasconrado@gmail.com)
- [ ] Should redirect to `/` as authenticated user
- [ ] Check session persistence (refresh page → still logged in)
- [ ] Try with a new Google account (should create new user)
- [ ] Verify user record in database has `avatar`, `provider=google`, `provider_id=<sub>`

## What Was Already Correct

✅ Environment variables (both local and Railway):
  - `NUXT_OAUTH_GOOGLE_CLIENT_ID`
  - `NUXT_OAUTH_GOOGLE_CLIENT_SECRET`
  - `NUXT_OAUTH_GOOGLE_REDIRECT_URL`
  - `NUXT_SESSION_PASSWORD`

✅ OAuth handler logic (`server/routes/auth/google.get.ts`)
✅ Google Cloud Console redirect URI configuration

## Related Files Changed

```
app/components/LoginModal.vue         # Error display
package.json                          # Migration scripts
server/database/migrate.ts            # NEW: Migration runner
server/database/migrations/0001_fuzzy_domino.sql  # NEW: Schema fix
```

## Deployment

**Commit:** `bf07a09` - "fix: Google OAuth login loop"
**Pushed to:** `master` branch
**Railway:** Auto-deploy triggered ✅

## Lessons Learned

1. **Always run migrations after schema changes** - The schema was updated but migrations weren't generated/applied
2. **Show errors to users** - Silent failures create confusion
3. **Check production logs** - Railway logs revealed the exact error
4. **Test OAuth flow end-to-end** - Easy to miss schema mismatches in dev

## Future Improvements

- [ ] Add automated schema sync check in CI/CD
- [ ] Create pre-push hook to verify migrations are up-to-date
- [ ] Add railway migration runner to deployment pipeline
- [ ] Implement proper error tracking (Sentry?)
- [ ] Add OAuth integration tests

---

**Fixed by:** Subagent (fix-google-oauth)
**Main session:** agent:main:main
**Channel:** telegram
